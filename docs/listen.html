<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="Подкасты радио Вести ФМ" />
    <meta name="keywords" content="подкаст, фести фм, vestifm, podcast" />
    <title>Подкасты -</title>
    <link rel="icon" type="image/png" href="/img/favicon.png" />
    <!--link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <div class="container">
      <div class="row mt-5">
        <div class="col"></div>
        <div class="col-10">
          <div class="">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Главная</a></li>
                <li
                  class="breadcrumb-item active"
                  aria-current="page"
                  id="menuBrandName"
                ></li>
              </ol>
            </nav>
            <h1 id="brandName"></h1>
          </div>
          <div id="episods">
            Ошибка. Не можем получить данные с сервера. Убедитесь, что ваш
            браузер не блокирует работу JavaScript.
          </div>
          <div class="d-flex justify-content-center mb-5">
            <button class="btn btn-primary" onClick="loadMore()">
              Загрузить еще
            </button>
          </div>
          <div class="fixed-bottom d-flex bg-white justify-content-center">
            <audio controls id="audioPlayer" class="col-8" preload="auto">
              <source id="audioSource" type="audio/mp3" />
              Your browser does not support the audio element.
            </audio>
          </div>
        </div>
        <div class="col"></div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <!--script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script-->

    <script>
      const container = document.getElementById("episods");
      const brandName = document.getElementById("brandName");
      const menuBrandName = document.getElementById("menuBrandName");

      const urlParams = new URLSearchParams(window.location.search);
      const pageParam = urlParams.get("page");
      let pages = pageParam ? parseInt(pageParam) : 1;

      const brandIdParam = urlParams.get("brand_id");
      const rubricIdParam = urlParams.get("rubric_id");
      const brand_id = brandIdParam ? parseInt(brandIdParam) : 1;
      const rubric_id = rubricIdParam ? parseInt(rubricIdParam) : 1;
      let firstItem = true;

      const loadItems = (pages) => {
        const itemsCount = pages * 6;

        let url = `https://rss.coyotle.ru/api/audios?brandId=${brand_id}&page=1&limit=${itemsCount}`;
        if (rubric_id > 1)
          url = `https://rss.coyotle.ru/api/audios?rubricId=${rubric_id}&page=1&limit=${itemsCount}`;
        console.log(url);

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            const title = data.contents[0].list[0].title;
            document.title = `Подкаст - ${title}`;
            menuBrandName.innerHTML = title;
            brandName.innerHTML = title;
            const blocks = data.contents[0].list.map((item) => {
              return `
                    <div class="card shadow mb-3">
                        <div class="card-body d-flex flex-column">
                          <h4>${item.anons}</h4>
                          <p class="text-secondary">${item.published}</p>
                          <p>${item.description}</p>
                          <!--audio controls src="https://vgtrk-podcast.cdnvideo.ru/audio/listen?id=${item.id}"></audio-->
                          <div>
                          <button class="btn btn-secondary" onClick="playPodcast(${item.id})"><i class="bi bi-play-fill"></i> Слушать</button>
                          </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = blocks.join("");

            if (firstItem) {
              const itemId = data.contents[0].list[0].id;
              const src = `https://vgtrk-podcast.cdnvideo.ru/audio/listen?id=${itemId}`;
              var audioPlayer = document.getElementById("audioPlayer");
              var audioSource = document.getElementById("audioSource");
              audioSource.src = src;
              audioPlayer.load();
              firstItem = false;
            }

            console.log(pages);
          })
          .catch((error) => console.error("Error:", error));
      };

      const loadMore = () => {
        pages = pages + 1;
        const newUrl = `${window.location.pathname}?brand_id=${brand_id}&page=${pages}`;
        history.pushState({ page: pages }, null, newUrl);
        loadItems(pages);
      };

      loadItems(pages);
    </script>

    <script>
      function playPodcast(audioId) {
        const src = `https://vgtrk-podcast.cdnvideo.ru/audio/listen?id=${audioId}`;
        console.log(src);
        var audioPlayer = document.getElementById("audioPlayer");
        var audioSource = document.getElementById("audioSource");

        audioSource.src = src;
        audioPlayer.load();
        audioPlayer.play();
      }
    </script>
  </body>
</html>
